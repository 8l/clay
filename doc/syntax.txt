Program -> TopLevelItem* ;

TopLevelItem -> PredicateDef | InstanceDef | RecordDef
              | VariableDef | ProcedureDef | OverloadableDef | OverloadDef ;

PredicateDef -> "predicate" Name ;
InstanceDef -> "instance" Name TypeVars? "(" comma_list(TypeExpr) ")"
               TypeConditions? ";" ;

TypeVars -> "[" comma_list(Name) "]" ;
TypeConditions -> "if" comma_list(TypeCondition) ;
TypeCondition -> Name "(" comma_list(TypeExpr) ")" ;

RecordDef -> "record" Name TypeVars? "{" FieldDef+ "}" ;
FieldDef -> Name TypeSpec ";" ;

TypeSpec -> ":" TypeExpr ;

Variable -> Name TypeSpec? ;

VariableDef -> "var" Variable "=" Expression ";" ;

ProcedureDef -> "def" Name Procedure ;

Procedure -> TypeVars? "(" comma_list(Argument)? ")"
             "ref"? TypeSpec? TypeConditions? Block;

Argument -> "ref"? Variable
          | "type" Expression
          ;

OverloadableDef -> "overloadable" Name ";" ;

OverloadDef -> "overload" Name Procedure ;

Block -> "{" Statement+ "}" ;

Statement -> Block
           | LocalVariableDef
           | Assignment
           | IfStatement
           | BreakStatement
           | ContinueStatement
           | WhileStatement
           | ForStatement
           | ReturnStatement
           | Expression
           ;

LocalVariableDef -> "var" Variable "=" Expression ";" ;

Assignment -> Expression "=" Expression ";" ;

IfStatement -> "if" "(" Expression ")" Statement
               ("else" Statement)? ;

BreakStatement -> "break" ";" ;
ContinueStatement -> "continue" ";" ;

WhileStatement -> "while" "(" Expression ")" Statement ;
ForStatement -> "for" "(" "var" Variable "in" Expression ")"
                Statement ;

ReturnStatement -> "return" Expression? ";" ;

TypeExpr -> Expression ;

Expression -> PrefixExpr ;

PrefixExpr -> AddressOfExpr
            | SuffixExpr
            ;
AddressOfExpr -> "&" SuffixExpr ;
SuffixExpr -> AtomicExpr Suffix* ;
Suffix -> IndexSuffix
        | CallSuffix
        | FieldRefSuffix
        | TupleRefSuffix
        | DereferenceSuffix
        ;
IndexSuffix -> "[" comma_list(Expression) "]" ;
CallSuffix -> "(" comma_list(Expression) ")" ;
FieldRefSuffix -> "." Name ;
TupleRefSuffix -> "." IntLiteral ;
DereferenceSuffix -> "^" ;

AtomicExpr -> ArrayExpr
            | TupleExpr
            | NameRef
            | Literal
            ;

ArrayExpr -> "[" comma_list(Expression) "]" ;
TupleExpr -> "(" comma_list(Expression) ")" ;

NameRef -> Name ;

Literal -> BoolLiteral
         | IntLiteral
         | CharLiteral
         | StringLiteral
         ;

BoolLiteral -> "true" | "false" ;
